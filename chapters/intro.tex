\chapter{绪论}
\section{数据中心网络}
现代数据中心在共享的设备资源基础上，为多个用户提供不同的服务。
为保障数据安全以及用户的独立性，数据中心向每个用户展现的是虚拟化的网络环境。
这就需要数据中心的管理者部署灵活的网络功能来实现这一要求。

由于硬件网络设备普遍灵活性受限，几乎所有的云服务商都用软件来实现其网络功能，
例如：微软、亚马逊、VMWare等\cite{azure, 179731}。但软件实现网络功能的性能天然存在两个问题：

其一，吞吐率受限。现有的软件定义网络功能通常需要使用两个以上核才能达到10Gbps带宽
\cite{Martins:2014:CAN:2616448.2616491,180672}，
而最新的网络设备带宽已达到40\textasciitilde 100Gbps\cite{edr}。
尽管增加单服务器的核数能够提升部分性能，但与此同时成本也会大幅提升。
一方面是设备开销提高，另一方面则是能耗显著增加。

其二，延迟高且不稳定。现有软件定义网络的处理延迟从几十微秒到毫秒量级不等
\cite{Gandhi:2014:DCS:2619239.2626317, Martins:2014:CAN:2616448.2616491, Patel:2013:ACS:2486001.2486026}。
无法满足证券交易等对低延迟要求严苛的应用需求。

在图形处理器(graphics processing unit, GPU)\cite{Han:2010:PGS:1851275.1851207}、
专用网络处理器\cite{cavium, netronome}和FPGA\cite{sigcomm2015keynote, Naous:2008:NRR:1397718.1397720}
上均有相关的工作旨在保障灵活性的基础上克服软件处理网络包的上述限制。
相比于GPU而言，FPGA能耗更低\cite{5681761, 5572788}；相比于专用网络处理器，FPGA可通过硬件逻辑实现更多服务所需的功能。
更重要的是，将FPGA部署在大规模数据中心的成本更低\cite{sigcomm2015keynote,6853195}。

在数据中心中利用FPGA加速软件网络功能从预期上能够达到较好的性能，
但实践中面临的主要问题是编程方面困难。传统的FPGA逻辑是通过Verilog、VHDL等硬件描述语言编写，
这些语言所展现的是门、寄存器、多路选择器、时钟等非常底层的器件。
这样虽然方便手工优化逻辑，但也导致编程复杂度高、开发效率低下、调试方面等问题。
这些困难导致多年来很多人远离FPGA编程\cite{Bacon:2013:FPM:2436256.2436271}。

本文借助微软亚洲研究院无线与网络研究组最新开发的ClickNP平台\cite{clicknp}进行FPGA编程，
对基于融合以太网的远程直接数据存取(remote direct memory access over converged Ethernet)协议进行分析和实现，
并对其性能进行评测。

\section{场效可编程门阵列体系结构}
场效可编程门阵列(FPGA)由大量逻辑门组成。其基本编程单元为逻辑块，由查找表和寄存器组成。
其中查找表可编程为任何组合逻辑计算，寄存器可以存储状态。
FPGA还包含存储数据的块随机访问存储器(block random access memory)、
处理复杂算术运算的数字信号处理单元(digital signal processing)。
FPGA通过PCIe子板与主机相连，其中子板包含数G字节的动态随机访问存储器(dynamic random access memory)
以及10G/40G以太网端口等其他通信界面。

相比于CPU和GPU而言，FPGA的时钟频率较低、访存带宽较小。
典型的FPGA时钟频率在200MHz左右，相比于时钟频率2\textasciitilde 3GHz的CPU低一个多数量级。
FPGA到单个块存储器和外部的动态存储器的带宽约为2\textasciitilde 4GBps，
而英特尔至强处理器的访存带宽约为40GBps，GPU的带宽则高达100GBps。

但相比于被有限核数限制并行数的CPU和GPU而言，FPGA的可并行化程度较高。
现代的FPGA可以集成数百万个逻辑块、数百Kbit寄存器、数十Mbit块存储器以及数千个数字信号处理单元。
理论上，所有这些器件均可并行地工作。因此数千个“核”在同一个FPGA芯片中并行工作是有可能的。
尽管单个块存储器的带宽有限，但同时访问数千个块存储器可使带宽达到TBps量级。

传统的FPGA编程使用Verilog、VHDL等硬件描述语言实现。这些语言关注底层细节，难于学习，编程复杂。
为了减轻编程负担，工业界与学术界均有开发高级编程工具，将以C语言为主的高级语言编写的程序转化为硬件程序。
其中包括微软亚洲研究院无线与网络研究组开发的ClickNP编程平台\cite{clicknp}。

FPGA上的程序在工作中，有时需要访问主机内存。然而目前通过PCIe访存面临如下限制：
\begin{enumerate}
\item 我们使用的FPGA只支持PCI Express 2.0\cite{pcie}接口，其传输速率较慢，为32Gbps，在实际测试中则为25.6Gbps；
\item 在我们的FPGA中，直接数据存取控制器不支持发散汇聚映射\cite{chapter3}；
\item 我们使用的FPGA不支持单源输入输出虚拟化 (single-root I/O virtualization, SR-IOV)\cite{irsov}，
因而无法部署在虚拟机上。
\end{enumerate}

基于融合以太网的远程直接数据存取协议 (RoCE)是一项成熟的技术。本文旨在以兼容RoCE的网卡为代理，
让FPGA上的应用更加高速低延迟地访问主机存储器。

\chapter{远程直接数据存取协议}
\subsection{直接数据存取}
直接数据存取 (direct memory access, DMA) 是现代计算机系统中常见的访存方式，
这种方式使外围设备可以不经CPU而直接访问存储器。

在非DMA访存模式下，CPU采用可编程输入输出方式与外围设备进行数据交互。
在等待设备完成读写操作期间，CPU无法处理其他任务，这一停等浪费大量计算资源。

在DMA访存模式下，CPU将数据传输初始化，在随后的数据传输过程中处理其他任务。
在数据传输结束时，会从DMA控制器收到表明操作完成的中断。
这一特性既适用于数据传输率远高于CPU处理能力的情况，
也适用于需要CPU利用等待时间处理更重要任务的情况。

\subsection{远程直接数据存取}
远程直接数据存取 (remote direct memory access, RDMA) 是不经过任何一台设备上操作系统的设备间访存方式。

RDMA设备接收到特定的数据包之后不再交由操作系统处理，而直接根据其请求访问本地存储器并进行反馈。
而CPU只负责初始化和结束RDMA设备，在数据传输过程中不会收到中断请求。
